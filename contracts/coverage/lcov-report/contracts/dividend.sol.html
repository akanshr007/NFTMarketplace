<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/dividend.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> dividend.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">64.1% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>25/39</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">43.75% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>7/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">83.33% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">61.54% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>24/39</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//SPDX-License-Identifier:MIT
pragma solidity &gt;=0.8.17;
import "./interface/IXegaraNFT.sol";
import "./interface/IDividend.sol";
import "@openzeppelin/contracts-upgradeable/token/ERC20/IERC20Upgradeable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
&nbsp;
contract Dividend is OwnableUpgradeable, IDividend {
    address creator;
    address public admin;
    address dataAccessAdmin;
    uint tokenId;
    address[] shareHolders; // array to keep track of shareholders
    address NFT; //address of xegara NFT
    IERC20Upgradeable public dividendToken; //instance of ERC20 token
    uint start; //pointer to keep track of the starting point of the array
    uint xar_balance; //variable to keep track of XAR NFT deposited at the start of the year
    uint256 totalSupply; //variable to keep track of total supply
    mapping(address =&gt; uint) claimAmount; //mapping to keep track of claim amount of all the shareholders
    mapping(address =&gt; uint) shares; //mapping to keep track of the shares of each address
    mapping(address =&gt; bool) exists; // mapping to keep track of whether an address has any shares or not
&nbsp;
    function initialize(
        uint _tokenId,
        address _dividendToken,
        address _NFT,
        address _creator,
        address _admin,
        address _dataAccessAdmin
    ) external initializer {
        creator = _creator;
        admin = _admin;
        dataAccessAdmin = _dataAccessAdmin;
        NFT = _NFT;
        tokenId = _tokenId;
        dividendToken = IERC20Upgradeable(_dividendToken);
        __Ownable_init_unchained();
    }
&nbsp;
    /**
     * @dev Deposits dividend amount into the contract
     * @param amount The amount of dividend to be deposited
     */
&nbsp;
    function deposit_dividend(uint amount) public {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == creator || msg.sender == admin, "NA"); // Not Authorized
        xar_balance = amount;
        dividendToken.transferFrom(creator, address(this), amount);
    }
&nbsp;
    /**
     * @dev Calculates and accumulates dividend amount for shareholders
     */
    function calculate_dividend() public {
        totalSupply = IXegaraNFT(NFT).tokenSupply(tokenId);
&nbsp;
        // Calculate the amount of dividend to distribute to each shareholder
        uint amount_to_distribute = dividendToken.balanceOf(address(this)) / 12;
&nbsp;
        // Iterate over the list of shareholders
        for (uint i = start; i &lt; shareHolders.length; i++) {
            // Calculate the dividend amount for each shareholder based on their shares
            claimAmount[shareHolders[i]] +=
                (shares[shareHolders[i]] * amount_to_distribute) /
                totalSupply;
        }
    }
&nbsp;
    /**
     * @dev Claims dividend amount for the caller
     */
<span class="fstat-no" title="function not covered" >    function claim_dividend() public {</span>
        // Get the dividend amount available for the caller
<span class="cstat-no" title="statement not covered" >        uint claim = claimAmount[msg.sender];</span>
&nbsp;
        // Ensure that there is a dividend to claim and the caller owns shares
<span class="cstat-no" title="statement not covered" >        require(claim &gt; 0, "Dividend already claimed or doesn't own shares")</span>;
&nbsp;
        // Set the claimed amount to 0 to prevent double claiming
<span class="cstat-no" title="statement not covered" >        claimAmount[msg.sender] = 0</span>;
&nbsp;
        // Transfer the dividend amount to the caller
<span class="cstat-no" title="statement not covered" >        dividendToken.transfer(msg.sender, claim)</span>;
    }
&nbsp;
    /**
     * @dev Tracks the transfer of shares from one address to another
     * @param amount The amount of shares being transferred
     * @param from The address from which shares are being transferred
     * @param to The address to which shares are being transferred
     */
    function trackShares(uint amount, address from, address to) public {
        // Ensure the amount is greater than zero
        <span class="missing-if-branch" title="else path not taken" >E</span>require(amount &gt; 0, "Amount should be greater than zero");
&nbsp;
        // Ensure the 'to' address is not the zero address
        <span class="missing-if-branch" title="else path not taken" >E</span>require(to != address(0), "To can't be zero address");
&nbsp;
        // Ensure the 'from' address has enough shares to transfer
&nbsp;
        // Track the previous amount of shares for the 'from' address
        uint prev_amount_from = shares[from];
&nbsp;
        // Check if the 'to' address already exists in the shareHolders list
        <span class="missing-if-branch" title="if path not taken" >I</span>if (exists[to]) {
            // Add the transferred amount to the existing shares of the 'to' address
<span class="cstat-no" title="statement not covered" >            shares[to] += amount</span>;
        } else {
            // Add the 'to' address to the shareHolders list
            shareHolders.push(to);
            // Set the shares of the 'to' address to the transferred amount
            shares[to] = amount;
            // Mark the 'to' address as existing
            exists[to] = true;
        }
&nbsp;
        // Handle the cases where the transferred amount is equal to or less than the previous amount of shares for the 'from' address
&nbsp;
        <span class="missing-if-branch" title="if path not taken" >I</span>if (amount == prev_amount_from) {
            // If the transferred amount is equal to the previous amount,
            // set the shares of the 'from' address to zero, mark it as not existing,
            // and rearrange the shareHolders list by moving the 'from' address to the end of the processed addresses
<span class="cstat-no" title="statement not covered" >            shares[from] = 0</span>;
<span class="cstat-no" title="statement not covered" >            exists[from] = false</span>;
<span class="cstat-no" title="statement not covered" >            uint i = start;</span>
<span class="cstat-no" title="statement not covered" >            while (shareHolders[i] != from) {</span>
                i++;
            }
<span class="cstat-no" title="statement not covered" >            address temp = shareHolders[start];</span>
<span class="cstat-no" title="statement not covered" >            shareHolders[start] = shareHolders[i]</span>;
<span class="cstat-no" title="statement not covered" >            shareHolders[i] = temp</span>;
<span class="cstat-no" title="statement not covered" >            start += 1</span>;
        } else <span class="missing-if-branch" title="if path not taken" >I</span>if (amount &lt; prev_amount_from) {
            // If the transferred amount is less than the previous amount,
            // subtract the transferred amount from the shares of the 'from' address
<span class="cstat-no" title="statement not covered" >            shares[from] -= amount</span>;
        }
    }
&nbsp;
    function DividendAmount(
        address shareHolder
    ) external view returns (uint256) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == dataAccessAdmin, "Not Authorized");
        return claimAmount[shareHolder];
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Aug 14 2023 11:45:43 GMT+0530 (India Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
